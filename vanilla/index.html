<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  <div class="wrapper">
    <div v-if="!step2" class="step1">
      <input @vue:mounted="$el.focus()" class="barcode" pattern="\d*" type="text" @input="fetchStep1" v-model="barcode">
      <button class="fetch1" @click="fetchStep1">Отправить</button>
      <p class="err1" v-if="data.error !== 0">{{data.error}}</p>
      <p class="saved" v-if="data2.status !== undefined" >Сохранено:<br/> {{data2.name}}}</p>
    </div>
    <div v-else class="step2">
      <p class="name">{{data.name}}</p>
      <div class="cost">
        <p>Цена 1: {{data.cost1}}</p>
        <p>Цена 2: {{data.cost2}}</p>
      </div>
      <div class="amount">
        <p>Кол-во 1: {{data.amount1}}</p>
        <p>Кол-во 2: {{data.amount2}}</p>
      </div>
      <div>
        Введите количество #3
        <input class="amount3" v-model="data.amount3">
        <div class="amount-input">
          <button class="amount-btn" @click="addNumber('1')">1</button>
          <button class="amount-btn" @click="addNumber('2')">2</button>
          <button class="amount-btn" @click="addNumber('3')">3</button>
          <button class="amount-btn" @click="addNumber('4')">4</button>
          <button class="amount-btn" @click="addNumber('5')">5</button>
          <button class="amount-btn" @click="addNumber('6')">6</button>
          <button class="amount-btn" @click="addNumber('7')">7</button>
          <button class="amount-btn" @click="addNumber('8')">8</button>
          <button class="amount-btn" @click="addNumber('9')">9</button>
          <button class="amount-btn" @click="addMinus()">-</button>
          <button class="amount-btn" @click="addNumber('0')">0</button>
          <button class="amount-btn" @click="clear">Cбросить</button>
          <button class="amount-btn" @click="addNumber('.')">.</button>
        </div>
        <button class="fetch2" @click="fetchStep2" class="rounded-lg h-12 bg-blue-500 text-white text-2xl">Отправить</button>
      </div>
    </div>
  </div>
  <script type="module">
    import { createApp } from 'https://cdnjs.cloudflare.com/ajax/libs/petite-vue/0.4.1/petite-vue.es.js'
    createApp({
      // barcode: '4820017000024',
      barcode: '',
      data: {},
      data2: {},
      step2: false,
      amount3: '',
      numerror: false,
      changed: false,
      defaultAmount3: null,

      async fetchStep1() {
          const response = await fetch('http://23.97.190.5/1c2/hs/tsd', {
            method: 'POST',
            mode: 'cors',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              barcode: this.barcode,
              step: 1
            })
          })
          let data = await response.json();
          let defaultAmount3 = data.amount3
          this.defaultAmount3 = defaultAmount3
          console.log(defaultAmount3);
          this.data = data
          if(this.data.error !== 0) {
            console.error(`Error: ${this.data.error}`);
          } else {
            console.log(`Sent: ${data}`);
            this.step2 = true
          }
      },
      addNumber(num){
        console.log(this.changed);
        if(this.changed === false) {
          this.data.amount3 = num
          this.changed = true
        } else {
          this.data.amount3 = this.data.amount3 + num
        }
      },
      addMinus(){
        this.data.amount3 = `-${this.data.amount3}`
      },
      clear(){
        this.data.amount3 = this.defaultAmount3
      },
      async fetchStep2() {
        try {
          const response = await fetch('http://23.97.190.5/1c2/hs/tsd', {
          method: 'POST',
          mode: 'cors',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            guid: this.data.guid,
            amount3: this.data.amount3,
            step: 2
          })
        })
        let data = await response.json();
        this.data2 = data
        console.log(`Saved: ${JSON.stringify(this.data2)}`);
        this.step2 = false
        this.barcode = ''
        this.changed = false
        } catch(error) {
          console.error(`Error: ${error}`);
        }
      }
    })
    .mount('.wrapper')
  </script>
  <script src="/main.js" type="module"></script>
</body>
<style>
  html, body {
    font-family: 'Arial', sans-serif;
  }
  .wrapper {
    min-height: 100vh;
    display: flex;
    align-items: center;
    padding-inline: 8px;
  }
  .step1 {
    display: flex;
    flex-direction: column;
    gap: 20px;
    width: 100%;
  }
  .barcode {
    height: 56px;
    font-size: 42px;
    border-color: rgb(96 165 250);
    border-radius: 8px;
    text-align: center;
    appearance: none;
  }
  .fetch1,.fetch2 {
    height: 36px;
    font-size: 18px;
    padding: 4px;
    line-height: 1;
    background: rgb(96 165 250);
    border: none;
    border-radius: 8px;
    color: white;
    width: 100%;
  }
  .name {
    text-align: center;
    font-size: 24px;
    margin: 0;
  }
  .cost, .amount {
    display: flex;
    justify-content: space-between;
  }
  .amount3 {
    height: 56px;
    font-size: 48px;
    border: 1px solid;
    border-color: rgb(96 165 250);
    border-radius: 8px;
    text-align: center;
    width: 100%;
    margin-bottom: 16px;
  }
  .amount3::placeholder {
    color: rgb(156 163 175);
  }
  .amount-input {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-bottom: 24px;
  }
  .amount-btn {
    border: none;
    background: rgb(96 165 250);
    color: white;
    font-size: 24px;
    border-radius: 8px;
  }
  .err1 {
    font-size: 28px;
    color: rgb(248 113 113);
    text-align: center;
  }
  .saved {
    font-size: 28px;
    color: rgb(96 165 250);
    text-align: center;
  }
</style>
</html>